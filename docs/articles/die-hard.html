<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hedgehog - Die Hard Water Jugs • hedgehog</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">hedgehog</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/hedgehog.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/die-hard.html">Hedgehog - Die Hard Water Jugs</a>
    </li>
    <li>
      <a href="../articles/state-machines.html">Hedgehog - State Machine Testing</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Hedgehog - Die Hard Water Jugs</h1>
                        <h4 class="author">Huw Campbell</h4>
            
            <h4 class="date">2017-10-06</h4>
          </div>

    
    
<div class="contents">
<p><img src="hedgehog-logo.png" width="307" align="right"></p>
<blockquote>
<p>Hedgehog will eat all your bugs.</p>
</blockquote>
<p>Die Hard with a Vengeance is a great film, and has a few great brain teasers, including the eponymous water jug problem.</p>
<iframe width="500" height="300" src="https://www.youtube.com/embed/6cAbgAaEOVE?rel=0" frameborder="0" allowfullscreen>
</iframe>
<p>Using this problem as a demonstration of state machine and property based testing is not a new idea, and has previously been implemented in <a href="https://github.com/tlaplus/Examples/blob/master/specifications/DieHard/DieHard.tla">TLA+</a>, <a href="http://hypothesis.works/articles/how-not-to-die-hard-with-hypothesis/">hypothesis</a>, and even <a href="http://clrnd.com.ar/posts/2017-04-21-the-water-jug-problem-in-hedgehog.html">hedgehog</a> itself (using the haskell version); even so, it’s fun to compare.</p>
<p>The aim is to fill a jug with 4 gallons of water, given only a 3 gallon jug and 5 gallon jug; neither of which have accurate markings.</p>
<p>Now this particular problem is simple enough that we don’t need to employ state machine testing (although it would make it more than 10 times more efficient). Here’s how it looks:</p>
<p>First, we set up how out state will change, we’re just going to use a simple list to hold the state of the two jugs, and a switch will choose which action we will run.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">empty.jugs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">big =</span> <span class="dv">0</span>, <span class="dt">small =</span> <span class="dv">0</span>)
step &lt;-<span class="st"> </span><span class="cf">function</span>(jugs, action) {
  big   &lt;-<span class="st"> </span>jugs<span class="op">$</span>big
  small &lt;-<span class="st"> </span>jugs<span class="op">$</span>small
  <span class="cf">switch</span>(action
  , <span class="dt">empty.big    =</span> <span class="kw">list</span>(<span class="dt">big =</span> <span class="dv">0</span>, <span class="dt">small =</span> small)
  , <span class="dt">empty.small  =</span> <span class="kw">list</span>(<span class="dt">big =</span> big, <span class="dt">small =</span> <span class="dv">0</span>)
  , <span class="dt">fill.big     =</span> <span class="kw">list</span>(<span class="dt">big =</span> <span class="dv">5</span>, <span class="dt">small =</span> small)
  , <span class="dt">fill.small   =</span> <span class="kw">list</span>(<span class="dt">big =</span> big, <span class="dt">small =</span> <span class="dv">3</span>)
  , <span class="dt">small.to.big =</span> { big.new &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="dv">5</span>, big <span class="op">+</span><span class="st"> </span>small)
                     <span class="kw">list</span>(<span class="dt">big =</span> big.new, <span class="dt">small =</span> small <span class="op">-</span><span class="st"> </span>(big.new <span class="op">-</span><span class="st"> </span>big))}
  , <span class="dt">big.to.small =</span> { small.new &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="dv">3</span>, big <span class="op">+</span><span class="st"> </span>small)
                     <span class="kw">list</span>(<span class="dt">big =</span> big <span class="op">-</span><span class="st"> </span>(small.new <span class="op">-</span><span class="st"> </span>small), <span class="dt">small =</span> small.new)}
  )
}</code></pre></div>
<p>We’ll need a function which runs over all of the steps we can choose.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">run.steps &lt;-<span class="st"> </span><span class="cf">function</span>(steps) {
  <span class="kw">Reduce</span>(step, steps, empty.jugs)
}</code></pre></div>
<p>And just an example of these function working</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">run.steps</span>(<span class="kw">c</span>(<span class="st">"fill.small"</span>, <span class="st">"small.to.big"</span>, <span class="st">"fill.small"</span>))</code></pre></div>
<pre><code>## $big
## [1] 3
## 
## $small
## [1] 3</code></pre>
<p>Ok, now what we want to find is a sequence of events which will leave the big jug with 4 gallons. An alternative way to think about this, is we can try and show the opposite, that all sequences must not have a result of 4 gallons, and if there is, try and find the smallest counterexample</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">actions &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"empty.big"</span>, <span class="st">"empty.small"</span>, <span class="st">"fill.big"</span>, <span class="st">"fill.small"</span>, <span class="st">"small.to.big"</span>, <span class="st">"big.to.small"</span>)

<span class="kw">test_that</span>(<span class="st">"The big water jug can't have 4 gallons"</span>,
  <span class="kw"><a href="../reference/forall.html">forall</a></span>(
    <span class="kw"><a href="../reference/gen.c.html">gen.c</a></span>(<span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(actions), <span class="dt">from =</span> <span class="dv">5</span>, <span class="dt">to =</span> <span class="dv">20</span>)
  , <span class="cf">function</span>(steps) <span class="kw">expect_false</span>(<span class="dv">4</span> <span class="op">==</span><span class="st"> </span><span class="kw">run.steps</span>(steps)<span class="op">$</span>big)
  , <span class="dt">tests =</span> <span class="dv">10000</span>
  )
)</code></pre></div>
<pre><code>## Error: Test failed: 'The big water jug can't have 4 gallons'
## * Falsifiable after 1236 tests, and 14 shrinks
## 4 == run.steps(steps)$big isn't false. 
## Counterexample:
## [1] "fill.big"     "big.to.small" "empty.small"  "big.to.small"
## [5] "fill.big"     "big.to.small"</code></pre>
<p>Awesome, this is indeed the minimal example of how to solve this problem. One irksome thing though, is that we had to crank up the number of tests quite high, and only saw a result at around 1000 tests. This is completely sufficient here, but in a more complex system, it would pay to be more efficient.</p>
<p>Although it’s overkill for this problem, <a href="state-machines.html">state-machine</a> provides a powerful framework for reducing the number of examples required here by more than a factor of 10. The idea is that we can set expectations for all state transitions instead of only checking at the end, as well as set pre-conditions such that actions with no effect (like emptying an empty jug) won’t be considered.</p>
<div id="state-machine" class="section level2">
<h2 class="hasAnchor">
<a href="#state-machine" class="anchor"></a>State Machine</h2>
<p>First thing we need to do is convert our step function into a set of commands. Hedgehog provides the <code>command</code> function for this purpose. We’ll use a little helper function to do this.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">step.command &lt;-<span class="st"> </span><span class="cf">function</span>(action) {
  effectful  &lt;-<span class="st"> </span><span class="cf">function</span>(state) <span class="op">!</span><span class="kw">identical</span>(<span class="kw">step</span>(state, action), state)
  <span class="kw"><a href="../reference/command.html">command</a></span>(action
    , <span class="dt">generator =</span> <span class="cf">function</span>(state) <span class="cf">if</span> (<span class="kw">effectful</span>(state)) <span class="kw">list</span>() <span class="cf">else</span> <span class="ot">NULL</span>
    , <span class="dt">require   =</span> effectful
    , <span class="dt">execute   =</span> <span class="cf">function</span>(state) <span class="ot">NULL</span>
    , <span class="dt">update    =</span> <span class="cf">function</span>(state, ...) <span class="kw">step</span>(state, action)
    , <span class="dt">ensure    =</span> <span class="cf">function</span>(state, ...) { <span class="kw">expect_false</span>(<span class="dv">4</span> <span class="op">==</span><span class="st"> </span>state<span class="op">$</span>big )}
  )
}

commands &lt;-<span class="st"> </span><span class="kw">lapply</span>(actions, step.command)</code></pre></div>
<p>This function, given one of the character strings we used earlier, will create a hedgehog <code>command</code> suitable for state machine testing. Usually, one uses this functionality for testing an secondary system, which the <code>execute</code> function interacts with. Here we don’t need to do this, so this function does nothing. The generator and require are preconditioned on the action being effectful, and after every action we will test if the jugs are at the level we’re looking for.</p>
<p>We can now test that the post-conditions hold (or don’t in this case) for all sets of actions using the <code>expect_sequential</code> expectation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">test_that</span>(<span class="st">"The big water jug can't have 4 gallons"</span>,
  <span class="kw"><a href="../reference/forall.html">forall</a></span>(
    <span class="kw"><a href="../reference/gen.actions.html">gen.actions</a></span>(empty.jugs, commands)
  , <span class="cf">function</span>(steps) <span class="kw"><a href="../reference/expect_sequential.html">expect_sequential</a></span>(empty.jugs, steps)
  , <span class="dt">tests =</span> <span class="dv">1000</span>
  )
)</code></pre></div>
<pre><code>## Error: Test failed: 'The big water jug can't have 4 gallons'
## * Falsifiable after 98 tests, and 7 shrinks
## 4 == state$big isn't false. 
## Counterexample:
## [[1]]
## fill.big 
## output variable: 1 
## 
## [[2]]
## big.to.small 
## output variable: 8 
## 
## [[3]]
## empty.small 
## output variable: 9 
## 
## [[4]]
## big.to.small 
## output variable: 10 
## 
## [[5]]
## fill.big 
## output variable: 11 
## 
## [[6]]
## big.to.small 
## output variable: 12</code></pre>
<p>To see how to interact with systems including abstracted or difficult to observe state, see the <a href="state-machines.html">state-machines</a> vignette.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#state-machine">State Machine</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Huw Campbell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
