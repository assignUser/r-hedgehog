<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hedgehog - Property Testing in R • hedgehog</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/lumen/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">hedgehog</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/hedgehog.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/die-hard.html">Hedgehog - Die Hard Water Jugs</a>
    </li>
    <li>
      <a href="../articles/state-machines.html">Hedgehog - State Machine Testing</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Hedgehog - Property Testing in R</h1>
                        <h4 class="author">Huw Campbell</h4>
            
            <h4 class="date">2017-10-06</h4>
          </div>

    
    
<div class="contents">
<p><img src="hedgehog-logo.png" width="307" align="right"></p>
<blockquote>
<p>Hedgehog will eat all your bugs.</p>
</blockquote>
<p><a href="http://hedgehog.qa/">Hedgehog</a> is a modern property based testing system in the spirit of QuickCheck, originally written in Haskell, but now also available in R. One of the key benefits of Hedgehog is integrated shrinking of counterexamples, which allows one to quickly find the cause of bugs, given salient examples when incorrect behaviour occurs.</p>
<div id="features" class="section level1">
<h1 class="hasAnchor">
<a href="#features" class="anchor"></a>Features</h1>
<ul>
<li>Expressive property based testing</li>
<li>Integrated shrinking, shrinks obey invariants by construction.</li>
<li>Generators can be combined to build complex and interesting structures.</li>
<li>Abstract state machine testing.</li>
<li>Full compatibility with <a href="https://github.com/hadley/testthat">testthat</a> makes it easy to add property based testing, without disrupting your work flow.</li>
</ul>
</div>
<div id="example" class="section level1">
<h1 class="hasAnchor">
<a href="#example" class="anchor"></a>Example</h1>
<p>To get a quick look of how Hedgehog feels, here’s an example showing some of the properties a function which reverses a vector should have. We’ll be testing the <code>rev</code> function from <code>package:base</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">test_that</span>( <span class="st">"Reverse of reverse is identity"</span>,
  <span class="kw"><a href="../reference/forall.html">forall</a></span>( <span class="kw"><a href="../reference/gen.c.html">gen.c</a></span>( <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>) ), <span class="cf">function</span>(xs) <span class="kw">expect_equal</span>(<span class="kw">rev</span>(<span class="kw">rev</span>(xs)), xs))
)</code></pre></div>
<p>The property above tests that if I reverse a vector twice, the result should be the same as the vector that I began with. Hedgehog has generated 100 examples, and checked that this property holds in all of these cases.</p>
<p>As one can see, there is not a big step from using vanilla <code>testthat</code> to including hedgehog in one’s process. Inside a <code>test_that</code> block, one can add a <code>forall</code> and set expectations within it.</p>
<p>We use the term <code>forall</code> (which comes from predicate logic) to say that we want the property to be true no matter what the input to the tested function is. The first argument to <code>forall</code> is function to generate random values (the generator); while the second is the properties we wish to test.</p>
<p>The property above doesn’t actually completely specify that the <code>rev</code> function is accurate though, as one could replace <code>rev</code> with the identity function and still observe this result. We will therefore write one more property to thoroughly test this function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">test_that</span>( <span class="st">"Reversed of concatenation is flipped concatenation of reversed"</span>,
  <span class="kw"><a href="../reference/forall.html">forall</a></span>( <span class="kw">list</span>( <span class="dt">as =</span> <span class="kw"><a href="../reference/gen.c.html">gen.c</a></span>( <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>) )
              , <span class="dt">bs =</span> <span class="kw"><a href="../reference/gen.c.html">gen.c</a></span>( <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>) ))
        , <span class="cf">function</span>(as,bs) <span class="kw">expect_equal</span> ( <span class="kw">rev</span>(<span class="kw">c</span>(as, bs)), <span class="kw">c</span>(<span class="kw">rev</span>(bs), <span class="kw">rev</span>(as)))
  )
)</code></pre></div>
<p>This is now a well tested reverse function. Notice that the property function now accepts two arguments: <code>as</code> and <code>bs</code>. A list of generators in Hedgehog is treated as a generator of lists, and shrinks all members independently. We do however do our best to make sure that properties can be specified naturally if the generator is specified in this manner as a list of generators.</p>
<p>Now let’s look at an assertion which isn’t true so we can see what our counterexamples looks like</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">test_that</span>( <span class="st">"Reverse is identity"</span>,
  <span class="kw"><a href="../reference/forall.html">forall</a></span>( <span class="kw"><a href="../reference/gen.c.html">gen.c</a></span>( <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>) ), <span class="cf">function</span>(xs) <span class="kw">expect_equal</span>(<span class="kw">rev</span>(xs), <span class="kw">c</span>(xs)))
)</code></pre></div>
<pre><code>## Error: Test failed: 'Reverse is identity'
## * Falsifiable after 2 tests, and 7 shrinks
## rev(xs) not equal to c(xs).
## 2/2 mismatches (average diff: 1)
## [1] 2 - 1 ==  1
## [2] 1 - 2 == -1 
## Counterexample:
## [1] 1 2</code></pre>
<p>This test says that the reverse of a vector should equal the vector, which is obviously not true for all vectors. Here, hedgehog has run this expectation with random input, and found it to not be true. Instead of reporting it directly, it has shrunk the bad test case to the smallest counterexample it could find: <code>c(1,2)</code>. Hedgehog then reëmits this test error to <code>testthat</code>, which handles it as per usual and displays it to the user.</p>
</div>
<div id="generators" class="section level1">
<h1 class="hasAnchor">
<a href="#generators" class="anchor"></a>Generators</h1>
<p>Hedgehog exports some basic generators and plenty of combinators for making new generators. Here’s an example analogous to calling <code>sample</code> on a small list, using the hedgehog generator <code>gen.sample</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/generator_sampling.html">gen.sample</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>)</code></pre></div>
<pre><code>## Hedgehog generator:
## Example:
## [1] 3 2 5 1 4
## Initial shrinks:
## [1] 1 2 3 4 5
## [1] 1 2 3 5 4
## [1] 2 3 5 1 4
## [1] 1 2 5 3 4
## [1] 3 1 5 2 4
## [1] 3 2 1 5 4
## [1] 3 2 4 1 5</code></pre>
<p>This generator shrinks back towards the original list ordering the user supplied. Although only a few shrinks are shown above, these are actually just the first layer of a rose tree of possible shrinks. This integrated shrinking property is a key component of hedgehog, and gives us an excellent chance of reducing to the minimum possible counterexample.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">test_that</span>( <span class="st">"a is less than b + 1"</span>,
    <span class="kw"><a href="../reference/forall.html">forall</a></span>(<span class="kw">list</span>(<span class="dt">a =</span> <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>), <span class="dt">b =</span> <span class="kw"><a href="../reference/gen.unif.html">gen.unif</a></span>(<span class="dv">1</span>,<span class="dv">100</span>, <span class="dt">shrink.median =</span> F))
  , <span class="cf">function</span>(a, b) <span class="kw">expect_lt</span>( a, b <span class="op">+</span><span class="st"> </span><span class="dv">1</span> ))
)</code></pre></div>
<pre><code>## Error: Test failed: 'a is less than b + 1'
## * Falsifiable after 6 tests, and 9 shrinks
## 2 is not strictly less than b + 1. Difference: 0 
## Counterexample:
## $a
## [1] 2
## 
## $b
## [1] 1</code></pre>
<p>The generators <code>gen.c</code>, <code>gen.element</code>, and <code>gen.unif</code>, are related to standard R functions: <code>c</code>, to create a vector; <code>sample</code>, to sample from a list or vector; and <code>runif</code>, to sample from a uniform distribution. We try to maintain a relationship to R’s well known functions inside Hedgehog.</p>
<p>Generators are also monads, meaning that one can use the result of a generator to build a generator. An example of this is a list generator, which first randomly chooses a length, then generates a list of said length.</p>
<p>The <code>gen.map</code> function can be used to apply an arbitrary function to the output of a generator, while <code>gen.with</code> is useful in chaining the results of a generator.</p>
<p>In the following example, we’ll create a generator which builds two lists of length <code>n</code>, then turn them into a <code>data.frame</code> with <code>gen.map</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gen.df.of &lt;-<span class="st"> </span><span class="cf">function</span> ( n )
  <span class="kw"><a href="../reference/generators.html">gen.map</a></span> (
    as.data.frame,
    <span class="kw">list</span>( <span class="dt">as =</span> <span class="kw"><a href="../reference/gen.c.of.html">gen.c.of</a></span>(n, <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) )
        , <span class="dt">bs =</span> <span class="kw"><a href="../reference/gen.c.of.html">gen.c.of</a></span>(n, <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span>(<span class="dv">10</span><span class="op">:</span><span class="dv">20</span>) )
        )
    )

<span class="kw">test_that</span>( <span class="st">"Number of rows is 5"</span>,
  <span class="kw"><a href="../reference/forall.html">forall</a></span>( <span class="kw">gen.df.of</span>(<span class="dv">5</span>), <span class="cf">function</span>(df) <span class="kw">expect_equal</span>(<span class="kw">nrow</span>(df), <span class="dv">5</span>))
)</code></pre></div>
<p>While this is good, but we would also like to be able to create <code>data.frames</code> with a varying number of rows. Here, we’ll again test a property which is false in order to show how hedgehog will find the minimum shrink.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">gen.df &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/generators.html">gen.with</a></span> (
    <span class="kw"><a href="../reference/generator_sampling.html">gen.element</a></span> (<span class="dv">1</span><span class="op">:</span><span class="dv">100</span>)
    , gen.df.of
  )

<span class="kw">test_that</span>( <span class="st">"All data frames are of length 1"</span>,
  <span class="kw"><a href="../reference/forall.html">forall</a></span>( gen.df, <span class="cf">function</span>(x) <span class="kw">expect_equal</span>(<span class="kw">nrow</span>(x), <span class="dv">1</span>))
)</code></pre></div>
<pre><code>## Error: Test failed: 'All data frames are of length 1'
## * Falsifiable after 1 tests, and 9 shrinks
## nrow(x) not equal to 1.
## 1/1 mismatches
## [1] 2 - 1 == 1 
## Counterexample:
##   as bs
## 1  1 10
## 2  1 10</code></pre>
</div>
<div id="state-machine-testing" class="section level1">
<h1 class="hasAnchor">
<a href="#state-machine-testing" class="anchor"></a>State Machine Testing</h1>
<p>R is a multi-paradigm programming language, while all the tests we have seen so far have tested functions which have no side effects (pure functions).</p>
<p>To deal with more complex situations which might arise in practice, Hedgehog also supports testing stateful system using a state machine model under random actions.</p>
<p>The general idea is that we can generate a model of the system, with requirements and post-conditions for every action we can take. With a random sequence of actions, we can test our model of the system against the true implementation. Hedgehog will then be able to identify inconsistencies between the true implementation and the model, from which the programmer can ask whether this is a bug in the model or a true bug in the system.</p>
<p>John Hughes has a series of excellent <a href="https://www.youtube.com/watch?v=H18vxq-VsCk">talks</a> regarding testing of state based and non-deterministic systems using QuviQ’s proprietary QuickCheck implementation, which has been using these techniques to great effect for many years.</p>
<p>Hedgehog’s current implementation in R is still quite young, and not nearly as feature rich, but does still allow for interesting properties in stateful systems to be investigated. See the <a href="state-machines.html">state-machines</a> vignette for more information.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#features">Features</a></li>
      <li><a href="#example">Example</a></li>
      <li><a href="#generators">Generators</a></li>
      <li><a href="#state-machine-testing">State Machine Testing</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Huw Campbell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
